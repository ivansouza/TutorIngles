<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Visual - Stable</title>
    
    <!-- Carregamento Seguro das Bibliotecas -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- √çcones Lucide (Vers√£o espec√≠fica para estabilidade) -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>
</head>
<body class="bg-slate-50 select-none text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 0. PROTE√á√ÉO DE ERROS (Error Boundary) ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    return <div className="p-10 text-center"><h1>Algo deu errado.</h1><button onClick={()=>window.location.reload()} className="bg-blue-500 text-white p-2 rounded mt-4">Recarregar</button></div>;
                }
                return this.props.children;
            }
        }

        // --- 1. √çCONES SEGUROS ---
        // Se o Lucide falhar, mostra um texto simples em vez de travar
        const Icon = ({ name, className }) => {
            const iRef = useRef(null);
            useEffect(() => {
                try {
                    if (window.lucide && iRef.current) {
                        window.lucide.createIcons({
                            attrs: { class: className },
                            nameAttr: 'data-lucide',
                            icons: { [name]: iRef.current }
                        });
                    }
                } catch (e) { console.warn("Icon error", e); }
            }, [name, className]);
            return <i ref={iRef} data-lucide={name}></i>;
        };

        // --- 2. DADOS SIMPLIFICADOS E SEGUROS ---
        const safeDictionary = {
            subjects: [
                { en: "I", pt: "Eu", pron: "ai", is3rd: false },
                { en: "You", pt: "Voc√™", pron: "i√∫", is3rd: false },
                { en: "He", pt: "Ele", pron: "r√≠", is3rd: true },
                { en: "She", pt: "Ela", pron: "x√≠", is3rd: true },
                { en: "We", pt: "N√≥s", pron: "u-√≠", is3rd: false },
                { en: "They", pt: "Eles", pron: "d√™i", is3rd: false }
            ],
            verbs: [
                { base: "like", pt: "gosto de", pron: "l√°ic", s: "likes", spt: "gosta de", spron: "l√°ics" },
                { base: "want", pt: "quero", pron: "u√¢nt", s: "wants", spt: "quer", spron: "u√¢nts" },
                { base: "need", pt: "preciso de", pron: "n√≠d", s: "needs", spt: "precisa de", spron: "n√≠dz" },
                { base: "have", pt: "tenho", pron: "r√©v", s: "has", spt: "tem", spron: "r√©s" } // Have √© irregular
            ],
            complements: [
                { en: "pizza", pt: "pizza", pron: "p√≠t-za" },
                { en: "coffee", pt: "caf√©", pron: "c√≥-fi" },
                { en: "water", pt: "√°gua", pron: "u√≥-ter" },
                { en: "money", pt: "dinheiro", pron: "m√¢-nei" }
            ]
        };

        const generateSafeData = () => {
            try {
                const sub = safeDictionary.subjects[Math.floor(Math.random() * safeDictionary.subjects.length)];
                const verb = safeDictionary.verbs[Math.floor(Math.random() * safeDictionary.verbs.length)];
                const comp = safeDictionary.complements[Math.floor(Math.random() * safeDictionary.complements.length)];

                // L√≥gica de 3¬™ pessoa simples (He/She likes vs I like)
                const is3rd = sub.is3rd;
                const verbEn = is3rd ? verb.s : verb.base;
                
                // Ajuste grosseiro do PT para 3¬™ pessoa (ex: Eu gosto -> Ele gosta)
                // Se o verbo PT termina em 'o' (gosto), troca por 'a' (gosta). Regra b√°sica.
                let verbPt = verb.pt;
                if (is3rd && verb.pt.endsWith('o')) {
                    verbPt = verb.pt.slice(0, -1) + 'a'; 
                    if (verb.base === 'have') verbPt = 'tem'; // Exce√ß√£o manual
                }
                // Ajuste grosseiro para N√≥s (We)
                if (sub.en === 'We') {
                    if (verb.pt.endsWith('o')) verbPt = verb.pt.slice(0, -1) + 'amos'; // gostamos
                    if (verb.base === 'have') verbPt = 'temos';
                }
                // Ajuste grosseiro para Eles (They) - simplificado para singular na visualiza√ß√£o ou 'am'
                if (sub.en === 'They') {
                     if (verb.pt.endsWith('o')) verbPt = verb.pt.slice(0, -1) + 'am'; // gostam
                     if (verb.base === 'have') verbPt = 't√™m';
                }

                const verbPron = is3rd ? verb.spron : verb.pron;

                return {
                    pt: `${sub.pt} ${verbPt} ${comp.pt}`,
                    en: `${sub.en} ${verbEn} ${comp.en}`,
                    pron: `${sub.pron} ${verbPron} ${comp.pron}`
                };
            } catch (e) {
                console.error("Generator error", e);
                return { en: "Error", pt: "Erro", pron: "Error" };
            }
        };

        // --- 3. APLICA√á√ÉO ---
        const App = () => {
            const [data, setData] = useState(null);
            const [status, setStatus] = useState('idle');
            const [feedback, setFeedback] = useState(null);
            const [transcript, setTranscript] = useState("");
            const [mode, setMode] = useState('voice');
            const recognitionRef = useRef(null);

            // Carregar primeira frase
            useEffect(() => {
                setData(generateSafeData());
            }, []);

            const nextPhrase = () => {
                setFeedback(null);
                setTranscript("");
                setStatus('idle');
                setData(generateSafeData());
            };

            const speak = () => {
                if (!data) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(data.en);
                u.lang = 'en-US';
                u.rate = 0.8;
                // Tenta pegar voz Google de forma segura
                const voices = window.speechSynthesis.getVoices();
                const v = voices.find(v => v.lang === 'en-US' && v.name.includes("Google")) || voices.find(v => v.lang === 'en-US');
                if (v) u.voice = v;
                window.speechSynthesis.speak(u);
            };

            const listen = () => {
                if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                    setMode('text'); return alert("Sem suporte a voz");
                }
                const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                try {
                    const rec = new Recognition();
                    rec.lang = 'en-US';
                    rec.continuous = false;
                    rec.onstart = () => setStatus('listening');
                    rec.onend = () => { if(status==='listening') setStatus('idle'); };
                    rec.onresult = (e) => {
                        const t = e.results[0][0].transcript;
                        setTranscript(t);
                        validate(t);
                    };
                    rec.start();
                    recognitionRef.current = rec;
                } catch(e) {
                    console.error(e);
                    setStatus('idle');
                }
            };

            const validate = (text) => {
                if (!data) return;
                const cleanText = text.toLowerCase().replace(/[^a-z]/g, '');
                const cleanTarget = data.en.toLowerCase().replace(/[^a-z]/g, '');
                if (cleanText.includes(cleanTarget) || cleanTarget.includes(cleanText)) {
                    setFeedback('correct');
                    speak(); // Fala para refor√ßar
                } else {
                    setFeedback('incorrect');
                }
            };

            if (!data) return <div className="p-10 text-center">Carregando...</div>;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans max-w-md mx-auto shadow-2xl">
                    
                    {/* Header Clean */}
                    <div className="bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                        <span className="font-bold text-slate-700 text-lg">Tutor Visual</span>
                        <div className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-bold">BR Edition</div>
                    </div>

                    <main className="flex-1 p-4 flex flex-col gap-4">
                        
                        {/* CARD VISUAL */}
                        <div className="bg-white rounded-3xl shadow-lg border border-slate-100 p-6 flex flex-col gap-5 relative">
                            
                            <button onClick={nextPhrase} className="absolute top-4 right-4 p-2 bg-slate-50 rounded-full hover:bg-slate-100 text-slate-400">
                                <Icon name="refresh-cw" className="w-4 h-4" />
                            </button>

                            {/* PT */}
                            <div className="flex items-center gap-3">
                                <span className="text-2xl filter drop-shadow-sm">üáßüá∑</span>
                                <span className="text-xl font-bold text-slate-800 leading-snug">{data.pt}</span>
                            </div>

                            {/* EN */}
                            <div className="flex items-center gap-3">
                                <span className="text-2xl filter drop-shadow-sm">üá∫üá∏</span>
                                <span className="text-xl font-bold text-yellow-500 leading-snug">{data.en}</span>
                            </div>

                            {/* PRON */}
                            <div className="flex items-center gap-3">
                                <span className="text-2xl filter drop-shadow-sm">üó£Ô∏è</span>
                                <span className="text-xl font-bold text-orange-500 italic leading-snug">{data.pron}</span>
                            </div>
                        </div>

                        {/* Bot√£o OUVIR */}
                        <button onClick={speak} className="bg-indigo-50 text-indigo-600 font-bold py-4 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-transform">
                            <Icon name="volume-2" className="w-5 h-5" /> OUVIR NATIVO
                        </button>

                        {/* √ÅREA INTERATIVA */}
                        <div className="flex-1 flex flex-col justify-center items-center gap-4 min-h-[150px]">
                            {mode === 'voice' ? (
                                <div className="relative">
                                    {status === 'listening' && <div className="absolute inset-0 bg-green-400 rounded-full animate-ping opacity-30"></div>}
                                    <button 
                                        onClick={listen}
                                        className={`w-20 h-20 rounded-full flex items-center justify-center text-white shadow-xl transition-all active:scale-90 relative z-10
                                            ${status === 'listening' ? 'bg-red-500 scale-110' : 
                                              feedback === 'correct' ? 'bg-green-500' : 'bg-indigo-600'}`}
                                    >
                                        <Icon name="mic" className="w-8 h-8" />
                                    </button>
                                </div>
                            ) : (
                                <div className="w-full flex gap-2">
                                    <input 
                                        className="flex-1 p-3 border-2 border-slate-200 rounded-xl outline-none focus:border-green-500" 
                                        placeholder="Digite..." 
                                        value={transcript}
                                        onChange={e => setTranscript(e.target.value)}
                                    />
                                    <button onClick={() => validate(transcript)} className="bg-green-500 text-white px-4 rounded-xl font-bold">OK</button>
                                </div>
                            )}

                            <div className="text-center h-8">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">
                                    {status === 'listening' ? "Ouvindo..." : "Toque para falar"}
                                </p>
                                {feedback && (
                                    <p className={`font-bold mt-1 ${feedback==='correct' ? 'text-green-600' : 'text-red-500'}`}>
                                        {feedback === 'correct' ? "PERFEITO!" : "TENTE DE NOVO"}
                                    </p>
                                )}
                            </div>
                        </div>

                        {/* CONTROLES RODA P√â */}
                        <div className="flex gap-3 mt-auto">
                            <button onClick={() => setMode(m => m === 'voice' ? 'text' : 'voice')} className="p-4 bg-white border border-slate-200 rounded-xl text-slate-500">
                                <Icon name="keyboard" className="w-6 h-6" />
                            </button>
                            <button onClick={nextPhrase} className="flex-1 bg-slate-800 text-white font-bold py-4 rounded-xl flex justify-center items-center gap-2 shadow-lg active:scale-95 transition-transform">
                                Pr√≥xima <Icon name="arrow-right" className="w-5 h-5" />
                            </button>
                        </div>

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>

